<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>QR Attendance Scanner</title>

    <!-- QR Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

    <!-- Export Libraries (Excel & PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

    <style>
      :root {
        --theme-primary: #ff9103;
        --theme-primary-bg: #fff8e6;
        --theme-text: #212529;
        --theme-bg: #f4f6f9;
      }
      body {
        background: var(--theme-bg);
        font-family: 'Poppins', sans-serif;
        color: var(--theme-text);
      }

      /* --- Advanced Card Design --- */
      .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s;
      }
      .card-header {
        background-color: #fff;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        padding: 1.25rem;
        font-weight: 700;
        color: var(--theme-text);
      }

      /* --- Scanner Styling --- */
      #reader {
        width: 100%;
        border-radius: 8px;
        overflow: hidden;
        box-shadow:
          0 0 0 4px var(--theme-primary-bg),
          0 0 0 5px var(--theme-primary);
      }

      /* --- Theme Overrides --- */
      .text-primary {
        color: var(--theme-primary) !important;
      }
      .bg-primary {
        background-color: var(--theme-primary) !important;
        color: #000 !important;
      }
      .btn-primary {
        background-color: var(--theme-primary);
        border-color: var(--theme-primary);
        color: #000;
        font-weight: 600;
      }
      .btn-primary:hover {
        background-color: #e68200;
        border-color: #e68200;
      }
      .btn-outline-primary {
        color: var(--theme-primary);
        border-color: var(--theme-primary);
      }
      .btn-outline-primary:hover {
        background-color: var(--theme-primary);
        color: #000;
      }

      /* --- Navbar & Stats --- */
      .navbar-custom {
        background: #fff;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border-top: 4px solid var(--theme-primary);
      }
      .stat-card-icon {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        font-size: 1.5rem;
      }
      .bg-orange-light {
        background-color: var(--theme-primary-bg);
        color: var(--theme-primary);
      }

      /* Theme Overrides */
      .table-dark {
        --bs-table-bg: #212529;
        --bs-table-color: #fff;
      }

      #reader__dashboard button {
        border: 1px solid #a4a4a4;
        background: #fff;
        border-radius: 8px;
        padding: 0.31rem 1.21rem;
        margin: 0.85rem 0rem;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-custom mb-4">
      <div class="container">
        <a class="navbar-brand fw-bold d-flex align-items-center" href="#">
          <i class="bi bi-qr-code-scan text-primary fs-3 me-2"></i>
          <span>
            QR Attendance
            <span class="text-primary">.Pro</span>
          </span>
        </a>
        <div class="d-flex align-items-center opacity-0">
          <div class="text-end me-3 d-none d-sm-block">
            <div class="small text-muted">Current Time</div>
            <div class="fw-bold" id="clock">--:--:--</div>
          </div>
        </div>
      </div>
    </nav>

    <div class="container">
      <!-- Stats Dashboard -->
      <div class="row g-4 mb-4">
        <div class="col-md-4">
          <div class="card p-3 h-100 d-flex flex-row align-items-center justify-content-between">
            <div>
              <h6 class="text-muted mb-1">Total Scanned</h6>
              <h3 class="fw-bold mb-0" id="statTotal">0</h3>
            </div>
            <div class="stat-card-icon bg-orange-light">
              <i class="bi bi-people"></i>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3 h-100 d-flex flex-row align-items-center justify-content-between">
            <div>
              <h6 class="text-muted mb-1">Synced Online</h6>
              <h3 class="fw-bold mb-0 text-success" id="statSynced">0</h3>
            </div>
            <div class="stat-card-icon bg-success-subtle text-success">
              <i class="bi bi-cloud-check"></i>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3 h-100 d-flex flex-row align-items-center justify-content-between">
            <div>
              <h6 class="text-muted mb-1">Pending Sync</h6>
              <h3 class="fw-bold mb-0 text-warning" id="statPending">0</h3>
            </div>
            <div class="stat-card-icon bg-warning-subtle text-warning">
              <i class="bi bi-hourglass-split"></i>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-4">
        <!-- Scanner Section -->
        <div class="col-12 col-md-7 mx-auto col-lg-4">
          <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span>
                <i class="bi bi-camera-video text-primary me-2"></i>
                Scanner
              </span>
              <span class="badge bg-danger blink_me">Live</span>
            </div>
            <div class="card-body text-center p-4">
              <div id="reader"></div>
              <div id="statusMessage" class="mt-3"></div>

              <hr class="my-4 opacity-10" />

              <!-- Manual Entry Form -->
              <label class="form-label text-muted small fw-bold text-start w-100">MANUAL ENTRY</label>
              <div class="input-group">
                <input type="text" id="manualInput" class="form-control" placeholder="Enter ID or Note" />
                <button class="btn btn-primary" type="button" id="manualAddBtn">
                  <i class="bi bi-plus-lg"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Table Section -->
        <div class="col-lg-8">
          <div class="card shadow-sm h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span>
                <i class="bi bi-list-check text-primary me-2"></i>
                Attendance Log
              </span>
              <div class="d-flex gap-2">
                <button id="btnSyncCloud" class="btn btn-sm btn-outline-primary" title="Sync from Cloud">
                  <i class="bi bi-cloud-download"></i>
                </button>
                <div class="dropdown">
                  <button class="btn btn-sm btn-outline-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-download"></i>
                    Export
                  </button>
                  <ul class="dropdown-menu">
                    <li>
                      <a class="dropdown-item" href="#" id="btnExportExcel">
                        <i class="bi bi-file-earmark-excel text-success"></i>
                        Excel
                      </a>
                    </li>
                    <li>
                      <a class="dropdown-item" href="#" id="btnExportPdf">
                        <i class="bi bi-file-earmark-pdf text-danger"></i>
                        PDF
                      </a>
                    </li>
                  </ul>
                </div>
                <button id="clearBtn" class="btn btn-sm btn-outline-danger">
                  <i class="bi bi-trash"></i>
                  Clear
                </button>
              </div>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                  <thead class="table-light text-secondary small text-uppercase">
                    <tr>
                      <th class="ps-4">#</th>
                      <th>Unique ID</th>
                      <th>Scan Time</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="scanTableBody" class="border-top-0"></tbody>
                </table>
              </div>

              <!-- Empty State (Visible if needed via JS, but keeping simple for now) -->
              <div id="emptyState" class="text-center py-5 d-none">
                <i class="bi bi-clipboard-x text-muted fs-1"></i>
                <p class="text-muted mt-2">No records found today.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="text-center py-4 text-muted small mt-5">&copy; 2026 QR Attendance System. All rights reserved.</footer>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      /* ========= CLOCK ========= */
      function updateClock() {
        const now = new Date();
        document.getElementById('clock').innerText = now.toLocaleTimeString();
      }
      setInterval(updateClock, 1000);
      updateClock();

      $(document).ready(function () {
        /* ========= LOAD STORED DATA ========= */
        let scannedUsers = JSON.parse(localStorage.getItem('scannedUsers')) || [];

        // Your Google Apps Script URL
        // Library: https://script.google.com/macros/library/d/1xwoXcP1pQ-jz4aN9e_D8LzPk5TNI72baThQyQNXJN5srPMpE0McZUzpn/2
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzJDergcwc3c1FrDo-Xwx4Ct2Fi10A_A-quY12SFKt4BIyEX31Z5by7LsFEbZkGomN1/exec';

        /* ========= UPDATE STATS ========= */
        function updateStats() {
          const total = scannedUsers.length;
          const synced = scannedUsers.filter((u) => u.synced).length;
          const pending = total - synced;

          $('#statTotal').text(total);
          $('#statSynced').text(synced);
          $('#statPending').text(pending);
        }

        /* ========= RENDER TABLE ========= */
        function renderTable() {
          const $tbody = $('#scanTableBody');
          $tbody.empty();

          if (scannedUsers.length === 0) {
            $('#emptyState').removeClass('d-none');
          } else {
            $('#emptyState').addClass('d-none');
          }

          // Show latest first
          const reversedUsers = [...scannedUsers].reverse();

          reversedUsers.forEach((scan, i) => {
            // Calculate original index
            const originalIndex = scannedUsers.length - i;

            const syncIcon = scan.synced ? '<span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill"><i class="bi bi-check-circle-fill me-1"></i>Synced</span>' : '<span class="badge bg-warning-subtle text-warning border border-warning-subtle rounded-pill"><i class="bi bi-hourglass-split me-1"></i>Pending</span>';

            const rowHtml = `
              <tr>
                <td class="ps-4 text-muted small">${originalIndex}</td>
                <td class="fw-bold text-dark">${scan.id}</td>
                <td class="text-secondary small">${scan.time}</td>
                <td>${syncIcon}</td>
              </tr>`;
            $tbody.append(rowHtml);
          });

          updateStats();
        }

        /* ========= SHOW STATUS ========= */
        function showStatus(msg, type) {
          const $statusDiv = $('#statusMessage');
          $statusDiv.html(`<div class="alert alert-${type} shadow-sm border-0" role="alert">${msg}</div>`);
          setTimeout(() => {
            $statusDiv.empty();
          }, 3000);
        }

        /* ========= SYNC TO GOOGLE SHEETS ========= */
        function syncData(scanData) {
          // If URL is not set, we just return (data stays pending)
          if (!GOOGLE_SCRIPT_URL.startsWith('https://script.google.com')) return;

          $.ajax({
            url: GOOGLE_SCRIPT_URL,
            type: 'POST',
            data: JSON.stringify(scanData),
            contentType: 'text/plain;charset=utf-8',
            success: function () {
              // Mark as synced
              // Find the item in the original array (since we might be viewing reversed)
              const item = scannedUsers.find((u) => u.id === scanData.id && u.time === scanData.time);
              if (item) item.synced = true;

              localStorage.setItem('scannedUsers', JSON.stringify(scannedUsers));
              renderTable();
            },
            error: function () {
              console.log('Sync failed (Offline?), will retry later.');
            },
          });
        }

        /* ========= DOWNLOAD FROM CLOUD (LIVE SYNC) ========= */
        function fetchCloudData(silent = false) {
          if (!GOOGLE_SCRIPT_URL.startsWith('https://script.google.com')) {
            if (!silent) showStatus('‚ùå Script URL not configured', 'danger');
            return;
          }

          const $btn = $('#btnSyncCloud');
          let originalHtml;

          if (!silent) {
            originalHtml = $btn.html();
            $btn.html('<span class="spinner-border spinner-border-sm"></span>').prop('disabled', true);
          }

          // Add timestamp to prevent caching
          const urlWithCache = GOOGLE_SCRIPT_URL + (GOOGLE_SCRIPT_URL.includes('?') ? '&' : '?') + 't=' + new Date().getTime();

          $.ajax({
            url: urlWithCache,
            type: 'GET',
            dataType: 'json',
            crossDomain: true,
            success: function (data) {
              let newCount = 0;
              // Merge cloud data with local data
              data.forEach((cloudItem) => {
                // Check if we already have this ID (Prevent duplicates)
                const exists = scannedUsers.some((local) => local.id == cloudItem.id);
                if (!exists) {
                  scannedUsers.push({ ...cloudItem, synced: true });
                  newCount++;
                }
              });

              if (newCount > 0) {
                localStorage.setItem('scannedUsers', JSON.stringify(scannedUsers));
                renderTable();
                showStatus(`‚úÖ Live Sync: Loaded ${newCount} new records.`, 'success');
              } else if (!silent) {
                showStatus(`‚úÖ Synced! Up to date.`, 'success');
              }
            },
            error: function (xhr, status, error) {
              console.error('Cloud Load Error:', status, error);
              if (!silent) {
                if (xhr.status === 0) {
                  showStatus('‚ö†Ô∏è CORS Error: Check "Anyone" permission in Google Script.', 'danger');
                } else if (xhr.status === 200) {
                  showStatus('‚ùå Error: Script returned HTML. Check "Anyone" permission.', 'danger');
                } else {
                  showStatus('‚ùå Failed to load. Check console.', 'danger');
                }
              }
            },
            complete: function () {
              if (!silent) {
                $btn.html(originalHtml).prop('disabled', false);
              }
            },
          });
        }

        // Manual Trigger
        $('#btnSyncCloud').click(function () {
          fetchCloudData(false);
        });

        // Auto Sync Interval (Every 5 seconds)
        setInterval(() => {
          fetchCloudData(true);
        }, 500);

        /* ========= PROCESS DATA (SCAN OR MANUAL) ========= */
        function processInput(data) {
          if (scannedUsers.some((u) => u.id === data)) {
            showStatus('‚ö†Ô∏è Already scanned today!', 'warning');
            return;
          }

          const scanData = {
            id: data,
            time: new Date().toLocaleString(),
            synced: false,
          };

          scannedUsers.push(scanData);
          localStorage.setItem('scannedUsers', JSON.stringify(scannedUsers));

          showStatus(`‚úÖ Recorded: ${data}`, 'success');
          renderTable();
          syncData(scanData);
        }

        /* ========= QR SUCCESS ========= */
        function onScanSuccess(decodedText) {
          processInput(decodedText.trim());
        }

        function onScanFailure(error) {
          // console.warn(`Code scan error = ${error}`);
        }

        /* ========= START SCANNER ========= */
        const html5QrcodeScanner = new Html5QrcodeScanner('reader', {
          fps: 10,
          qrbox: 250,
          videoConstraints: {
            facingMode: 'environment',
          },
        });

        html5QrcodeScanner.render(onScanSuccess, onScanFailure);

        /* ========= MANUAL ENTRY ========= */
        $('#manualAddBtn').click(function () {
          const val = $('#manualInput').val().trim();
          if (val) {
            processInput(val);
            $('#manualInput').val('');
          }
        });

        /* ========= ONLINE LISTENER ========= */
        window.addEventListener('online', function () {
          showStatus('üåê Back online! Syncing...', 'info');
          scannedUsers.forEach((item) => {
            if (!item.synced) syncData(item);
          });
        });

        /* ========= EXPORT TO EXCEL ========= */
        $('#btnExportExcel').click(function (e) {
          e.preventDefault();
          if (scannedUsers.length === 0) {
            showStatus('‚ö†Ô∏è No data to export', 'warning');
            return;
          }

          // Prepare data for Excel
          const data = scannedUsers.map((u, i) => ({
            '#': i + 1,
            'Employee ID': u.id,
            'Scan Time': u.time,
            'Sync Status': u.synced ? 'Synced' : 'Pending',
          }));

          const ws = XLSX.utils.json_to_sheet(data);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Attendance');
          XLSX.writeFile(wb, 'Attendance_Log.xlsx');
          showStatus('‚úÖ Excel downloaded successfully', 'success');
        });

        /* ========= EXPORT TO PDF ========= */
        $('#btnExportPdf').click(function (e) {
          e.preventDefault();
          if (scannedUsers.length === 0) {
            showStatus('‚ö†Ô∏è No data to export', 'warning');
            return;
          }

          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();

          doc.text('QR Attendance Log', 14, 15);
          doc.setFontSize(10);
          doc.text('Generated: ' + new Date().toLocaleString(), 14, 22);

          const tableColumn = ['#', 'Employee ID', 'Scan Time', 'Sync Status'];
          const tableRows = scannedUsers.map((u, i) => [i + 1, u.id, u.time, u.synced ? 'Synced' : 'Pending']);

          doc.autoTable({
            head: [tableColumn],
            body: tableRows,
            startY: 30,
          });

          doc.save('Attendance_Log.pdf');
          showStatus('‚úÖ PDF downloaded successfully', 'success');
        });

        /* ========= CLEAR DATA ========= */
        $('#clearBtn').click(function () {
          if (confirm('‚ö†Ô∏è DELETE ALL DATA? This will wipe Google Sheets and local history.')) {
            const $btn = $(this);
            const originalHtml = $btn.html();
            $btn.html('<span class="spinner-border spinner-border-sm"></span>').prop('disabled', true);

            const clearLocal = () => {
              localStorage.removeItem('scannedUsers');
              scannedUsers = [];
              renderTable();
            };

            if (GOOGLE_SCRIPT_URL.startsWith('https://script.google.com')) {
              $.ajax({
                url: GOOGLE_SCRIPT_URL,
                type: 'POST',
                data: JSON.stringify({ action: 'clear' }),
                contentType: 'text/plain;charset=utf-8',
                success: function () {
                  clearLocal();
                  showStatus('‚úÖ Cloud & Local data cleared!', 'success');
                },
                error: function () {
                  clearLocal();
                  showStatus('‚ö†Ô∏è Local cleared. Cloud clear failed.', 'warning');
                },
                complete: function () {
                  $btn.html(originalHtml).prop('disabled', false);
                },
              });
            } else {
              clearLocal();
              showStatus('‚úÖ Local data cleared.', 'success');
              $btn.html(originalHtml).prop('disabled', false);
            }
          }
        });

        renderTable();
      });
    </script>
  </body>
</html>
