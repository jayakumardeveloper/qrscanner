<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>QR Attendance Scanner</title>

    <!-- QR Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

    <style>
      :root {
        --theme-primary: #ff9103;
        --theme-black: #000;
        --theme-white: #fff;
      }
      body {
        background: var(--theme-white);
        font-family:
          system-ui,
          -apple-system,
          'Segoe UI',
          Roboto,
          'Helvetica Neue',
          Arial,
          sans-serif;
        color: var(--theme-black);
      }
      #reader {
        width: 100%;
        border: 2px solid var(--theme-primary) !important;
      }
      /* Theme Overrides */
      .text-primary {
        color: var(--theme-primary) !important;
      }
      .bg-primary {
        background-color: var(--theme-primary) !important;
        color: var(--theme-black) !important;
      }
      .table-dark {
        --bs-table-bg: var(--theme-black);
        --bs-table-color: var(--theme-white);
      }
      .btn-outline-dark {
        color: var(--theme-black);
        border-color: var(--theme-black);
      }
      .btn-outline-dark:hover {
        background-color: var(--theme-black);
        color: var(--theme-white);
      }
    </style>
  </head>
  <body class="py-4">
    <div class="container">
      <h2 class="text-center mb-4 text-primary fw-bold">
        <i class="bi bi-qr-code-scan"></i>
        QR Attendance Scanner
      </h2>

      <div class="row g-4">
        <!-- Scanner Section -->
        <div class="col-12 col-md-4">
          <div class="card shadow-sm">
            <div class="card-header bg-primary fw-bold">
              <i class="bi bi-camera-video"></i>
              Scan QR Code
            </div>
            <div class="card-body text-center">
              <div id="reader" class="border rounded overflow-hidden"></div>
              <div id="statusMessage" class="mt-3"></div>
            </div>
          </div>
        </div>

        <!-- Table Section -->
        <div class="col-12 col-md-8">
          <div class="card shadow-sm h-100">
            <div class="card-header d-flex justify-content-between align-items-center bg-white">
              <h5 class="mb-0 text-secondary">
                <i class="bi bi-list-check"></i>
                Attendance Log
              </h5>
              <button id="clearBtn" class="btn btn-sm btn-outline-dark">
                <i class="bi bi-trash"></i>
                Clear
              </button>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-striped table-hover mb-0 align-middle">
                  <thead class="table-dark">
                    <tr>
                      <th>#</th>
                      <th>ID</th>
                      <th>Name</th>
                      <th>Dept</th>
                      <th>Time</th>
                    </tr>
                  </thead>
                  <tbody id="scanTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      $(document).ready(function () {
        /* ========= LOAD STORED DATA ========= */
        let scannedUsers = JSON.parse(sessionStorage.getItem('scannedUsers')) || [];

        /* ========= RENDER TABLE ========= */
        function renderTable() {
          const $tbody = $('#scanTableBody');
          $tbody.empty();

          scannedUsers.forEach((scan, i) => {
            const rowHtml = `
              <tr>
                <td>${i + 1}</td>
                <td>${scan.id}</td>
                <td>N/A</td>
                <td>N/A</td>
                <td>${scan.time}</td>
              </tr>`;
            $tbody.append(rowHtml);
          });
        }

        /* ========= SHOW STATUS ========= */
        function showStatus(msg, type) {
          const $statusDiv = $('#statusMessage');
          $statusDiv.html(`<div class="alert alert-${type}" role="alert">${msg}</div>`);
          setTimeout(() => {
            $statusDiv.empty();
          }, 3000);
        }

        /* ========= QR SUCCESS ========= */
        function onScanSuccess(decodedText) {
          // prevent duplicate scan
          if (scannedUsers.some((u) => u.id === decodedText)) {
            showStatus('⚠️ Already scanned today!', 'warning');
            return;
          }

          const scanData = {
            id: decodedText,
            time: new Date().toLocaleString(),
          };

          scannedUsers.push(scanData);
          sessionStorage.setItem('scannedUsers', JSON.stringify(scannedUsers));

          showStatus(`✅ Scanned: ${decodedText}`, 'success');
          renderTable();
        }

        function onScanFailure(error) {
          // console.warn(`Code scan error = ${error}`);
        }

        /* ========= START SCANNER ========= */
        const html5QrcodeScanner = new Html5QrcodeScanner('reader', { fps: 10, qrbox: 250 });

        html5QrcodeScanner.render(onScanSuccess, onScanFailure);

        /* ========= CLEAR DATA ========= */
        $('#clearBtn').click(function () {
          if (confirm('Clear all attendance data?')) {
            sessionStorage.removeItem('scannedUsers');
            scannedUsers = [];
            renderTable();
          }
        });

        renderTable();
      });
    </script>
  </body>
</html>
